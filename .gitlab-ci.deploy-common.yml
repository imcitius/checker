variables:
  INSTANCE_DC: inst-dev
  INST_API_URL: "http://inst-api-test.service.${INSTANCE_DC}.consul"
  INST_UI_URL: "http://inst-ui-test.service.${INSTANCE_DC}.consul"
  INSTANCE_NAME: $CI_COMMIT_REF_SLUG
  REQUEST_FILE: "scripts/instance.json"

.run_cmd: &run_cmd |
  curl -X POST ${INST_API_URL}/instances \
  -H "Content-Type: application/json" \
  -d "@params.json"

.deploy:
  stage: deploy
  script:
    - echo "{}" | jq -f ${REQUEST_FILE} > params.json
    - *run_cmd

.destroy:
  stage: deploy
  when: manual
  script:
    - curl -X DELETE ${INST_API_URL}/instances/${CI_PROJECT_NAME}-${INSTANCE_NAME}
