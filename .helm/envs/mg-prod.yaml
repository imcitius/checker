db:
  check: true
  password_path: secret/mg-prod/pgsql-ext/checker/pass

app:
  config:
    routes:
      - Host(`mediaget.com`) && PathPrefix(`/checker/`)
    ingress:
      cert: wildcard-cert

checker_config_template: |
  ---
  defaults:
    http_port: '80'
    bots_enabled: true
    parameters:
      check_period: 900s
      report_period: 1800s
      min_health: 1
      allow_fails: 0
      noncrit_alert: prod
      crit_alert: prod
      command_channel: prod
      mode: loud
      ssl_expiration_period: 720h
  alerts:
    - name: prod
      type: telegram
  << file "/vault/secrets/telegram.env" | indent 4 >>
  projects:
    - name: mg-prod
      healthchecks:
        - name: api
          parameters:
            check_period: 60s
          checks:
            - type: http
              host: http://api/api/healthcheck
              answer: ^API OK$
              code:
                - 200
              timeout: 2s
              severity: critical
        - name: client
          parameters:
            check_period: 60s
          checks:
            - type: http
              host: http://client/check.php
              answer: ^ProjectM2Client OK$
              code:
                - 200
              timeout: 2s
              severity: critical
        - name: dht
          checks:
            - type: http
              host: http://dht/dht/healthcheck
              answer: ^API OK$
              code:
                - 200
              timeout: 2s
        - name: emailer
          checks:
            - type: http
              host: http://emailer/healthcheck
              answer: Emailer OK
              code:
                - 200
              timeout: 2s
        - name: Installer
          parameters:
            check_period: 60s
          checks:
            - type: http
              host: http://installer/health
              code:
                - 200
              timeout: 2s
              severity: critical
        - name: Ld
          parameters:
            check_period: 60s
          checks:
            - type: http
              host: http://ld/check.php
              answer: ^ProjectM2Ld OK$
              code:
                - 200
              timeout: 2s
              severity: critical
        - name: mg-backend
          parameters:
            check_period: 60s
          checks:
            - type: http
              host: http://mg-backend/bapi/healthcheck
              answer: ^API OK$
              code:
                - 200
              timeout: 2s
              severity: critical
        - name: mg-parser
          checks:
            - type: http
              host: http://mg-parser/healthcheck
              code:
                - 200
              timeout: 2s
        - name: mg-web
          parameters:
            check_period: 60s
          checks:
            - type: http
              host: http://mg-web/ping
              answer: ^pong$
              code:
                - 200
              timeout: 2s
              severity: critical
        - name: mg-msearch
          checks:
            - type: http
              host: http://msearch/check.php
              answer: ^ProjectM2Msearch OK$
              code:
                - 200
              timeout: 2s
        - name: mg-searcher
          checks:
            - type: http
              host: http://search:8081/search/healthcheck
              answer: ^searcher-search OK$
              code:
                - 200
              timeout: 2s
        - name: mg-similarity
          checks:
            - type: http
              host: http://similarity:8082/similarity/healthcheck
              answer: ^searcher-similarity OK$
              code:
                - 200
              timeout: 2s
        - name: mg-stat
          checks:
            - type: http
              host: http://stat/check.php
              answer: ^ProjectM2Stat OK$
              code:
                - 200
              timeout: 2s
        - name: catalogue-front
          parameters:
            check_period: 60s
          checks:
            - type: http
              host: http://cat-front/health
              code:
                - 200
              timeout: 2s
              severity: critical
        - name: grabbers
          checks:
            - type: http
              host: http://grabbers/healthcheck
              answer: ^Grabbers OK$
              code:
                - 200
              timeout: 2s
        - name: torrents-markup
          checks:
            - type: http
              host: http://markup/healthcheck
              answer: ^TorrentsMarkup OK$
              code:
                - 200
              timeout: 2s
        - name: torrents-markup-new-torrents
          parameters:
            check_period: 1h
          checks:
            - type: http
              host: http://markup/healthcheck/new-torrents
              answer: ^NewTorrents OK$
              code:
                - 200
                - 500
              timeout: 2s
        - name: pgsql-main
          parameters:
            check_period: 60s
          checks:
            - type: pgsql_replication
              host: pgsql.mg-prod.mediaget.com
              port: 5000
              sql_repl_config:
                dbname: checker
                username: checker
                password: << file "/vault/secrets/pgsql.env" >>
                tablename: repl_test
                sslmode: require
                serverlist:
                  - 51.158.156.17:5433
                  - 51.158.156.18:5433
                  - 51.158.156.19:5433
              severity: critical
            - type: pgsql_replication_status
              host: pgsql.mg-prod.mediaget.com
              port: 5000
              sql_repl_config:
                dbname: checker
                username: checker
                password: << file "/vault/secrets/pgsql.env" >>
                lag: 10s
              severity: critical

    - name: checker-fly.io crosscheck
      healthchecks:
        - name: MG prod checker Running
          checks:
            - type: http
              host: https://checker.fly.dev/check/ping/168bafa2-e61a-5895-b4fc-58095a86e691
              code:
                - 200
              timeout: 3s

  # добавить мантикору, imgproxy
  # добавить кроны в api, поисковике, где там еще они есть
