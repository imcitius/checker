project: checker
configVersion: 1
deploy:
  namespace: {{ .Values.werf.env }}
  helmRelease: checker
---
artifact: app
from: harbor.jgit.me/releases/golang-builder:1.16-alpine
git:
- to: /go/src
  stageDependencies:
    install:
    - "**/*.go"
    - "*.go"
    - "go.*"
shell:
  cacheVersion: 1
  install:
    - apk update && apk add git openssh
    - export GOOS="linux"
    - export GOARCH="amd64"
    - cd /go/src
    - go get -v -t -d ./...
#    - go lint ./...
    # go test needs cgo, needs gcc
#    - go test ./...
    - go build -v -i -x -o checker
# breaks giterminism, rebuild on every commit :(
#      -ldflags "-X my/checker/config.Version={{ env "CI_COMMIT_REF_NAME" }}
#      -X my/checker/config.VersionSHA={{ env "CI_COMMIT_SHORT_SHA" }}
#      -X my/checker/config.VersionBuild={{ env "CI_JOB_ID" }}"
    - chmod +x checker
---
image: checker
from: harbor.jgit.me/dockerhub_proxy/library/alpine
import:
- artifact: app
  add: /go/src/checker
  to: /checker
  after: install
docker:
  WORKDIR: /
