.build_inject_cmd: &build_inject_cmd |
  go build -ldflags \
  "-X my/checker/config.Version=${CI_COMMIT_REF_NAME}-fly -X my/checker/config.VersionSHA=${CI_COMMIT_SHORT_SHA}" \
  -o ${BINARY_NAME}

fly-deploy:
  stage: deploy
  image: golang:1.16
  before_script:
    - curl -fsSL https://apt.releases.hashicorp.com/gpg | apt-key add -
    - apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"
    - apt-get update -qq && apt-get install -y curl unzip vault
    - curl -L https://fly.io/install.sh | sh
  script:
    - export FLY_API_TOKEN=$(./vault read -field=token secret/fly.io/${FLY_ACCOUNT}/pass)
    - *build_inject_cmd
    - /root/.fly/bin/flyctl deploy
  extends:
    - .jgit_filter
    - .docker_europe_tags
  environment:
    name: fly-prod
  needs: []
